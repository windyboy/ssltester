version: '3'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Global variables (string-substituted everywhere)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
vars:
  VERSION:        '{{ .VERSION   | default "0.0.2" }}'
  PROJECT_NAME:   'ssl-test'
  HOST:           '{{ .HOST      | default "example.com" }}'
  PORT:           '{{ .PORT      | default "443" }}'
  TIMEOUT:        '{{ .TIMEOUT   | default "5000" }}'
  FORMAT:         '{{ .FORMAT    | default "TXT" }}'
  OUTPUT:         '{{ .OUTPUT    | default "" }}'
  JAVA_VERSION:   '21'
  KOTLIN_VERSION: '2.1.21'
  GRADLEW:        './gradlew'          # one place to edit if you move/rename the wrapper

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Environment variables exported into every cmd
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  GRADLE_OPTS: '-Dorg.gradle.jvmargs=-Xmx2G'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Tasks
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tasks:

  # --- Bootstrap / Setup ------------------------------------
  bootstrap:
    desc: Check and install required tools
    cmds:
      - echo 'ğŸ”§ Checking environmentâ€¦'
      - command -v java      >/dev/null 2>&1 || (echo 'âŒ Java not found!'          && exit 1)
      - command -v "{{.GRADLEW}}" >/dev/null 2>&1 || (echo 'âŒ Gradle wrapper missing' && exit 1)
      - echo 'âœ… Environment ready'

  validate-version:
    desc: Validate version format (semver)
    internal: true
    silent: true
    cmds:
      - echo '{{.VERSION}}' | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$' || (echo 'âŒ Invalid version format' && exit 1)
      - echo "âœ… Version {{.VERSION}} is valid"

  # --- Clean / Build ----------------------------------------
  clean:
    desc: Clean the project build files
    cmds:
      - echo 'ğŸ§¹ Cleaning projectâ€¦'
      - "{{.GRADLEW}} clean"
      - echo 'âœ… Clean completed'

  compile:
    desc: Compile the project
    deps: [validate-version]
    cmds:
      - echo 'ğŸ”¨ Compiling projectâ€¦'
      - "{{.GRADLEW}} compileKotlin"
      - echo 'âœ… Compilation completed'

  build:
    desc: Build the release artifacts
    deps: [validate-version, clean]
    cmds:
      - echo 'ğŸ—ï¸  Building projectâ€¦'
      - "{{.GRADLEW}} build --continue"
      - echo 'âœ… Build completed'

  "build:fat-jar":
    desc: Build fat JAR with all dependencies
    deps: [validate-version, clean]
    cmds:
      - echo 'ğŸ“¦ Building fat JARâ€¦'
      - "{{.GRADLEW}} shadowJar --continue"
      - echo 'âœ… Fat JAR created successfully'

  # --- Lint / Format ----------------------------------------
  lint:
    desc: Run code linting with ktlint
    cmds:
      - echo 'ğŸ” Running code lintingâ€¦'
      - "{{.GRADLEW}} ktlintCheck"
      - echo 'âœ… Linting passed'

  format:
    desc: Format code with ktlint
    cmds:
      - echo 'ğŸ¨ Formatting codeâ€¦'
      - "{{.GRADLEW}} ktlintFormat"
      - echo 'âœ… Code formatting completed'

  # --- Testing ----------------------------------------------
  "test:unit":
    desc: Run unit tests
    cmds:
      - echo 'ğŸ§ª Running unit testsâ€¦'
      - "{{.GRADLEW}} test --tests 'org.example.*Test' --continue"
      - echo 'âœ… Unit tests completed'

  "test:int":
    desc: Run integration tests
    cmds:
      - echo 'ğŸ”— Running integration testsâ€¦'
      - |
        if find app/src/test -name "*IT.kt" -o -name "*IT.java" | grep -q .; then
          {{.GRADLEW}} test --tests 'org.example.*IT' --continue
        else
          echo 'â„¹ï¸  No integration tests found (files ending with IT)'
        fi
      - echo 'âœ… Integration tests completed'

  "test:cli":
    desc: Test CLI functionality
    cmds:
      - echo 'ğŸ§ª Testing CLI functionalityâ€¦'
      - "{{.GRADLEW}} run --args='--help' >/dev/null 2>&1 && echo 'âœ… Help command works'"
      - "{{.GRADLEW}} run --args='--version' >/dev/null 2>&1 && echo 'âœ… Version command works'"
      - |
        {{.GRADLEW}} run --args='invalid-host-that-does-not-exist.com --port 443 --connect-timeout 1000' >/dev/null 2>&1 \
          && echo 'âœ… Invalid host handled gracefully' || echo 'âœ… Invalid host properly rejected'
      - echo 'âœ… CLI tests completed'

  test:
    desc: Run all tests
    deps: ["test:unit", "test:int", "test:cli"]

  "test:coverage":
    desc: Run tests with coverage report
    cmds:
      - echo 'ğŸ“Š Running tests with coverageâ€¦'
      - "{{.GRADLEW}} clean test jacocoTestReport --continue"
      - "echo 'ğŸ“ˆ Coverage report: app/build/reports/jacoco/test/html/index.html'"

  "coverage:show":
    desc: Show test coverage information and open reports
    cmds:
      - echo 'ğŸ“Š Test Coverage Information'
      - "{{.GRADLEW}} showCoverage"
      - "echo 'ğŸ“ HTML report location: app/build/reports/jacoco/test/html/index.html'"

  "coverage:check":
    desc: Check if test coverage meets minimum thresholds
    cmds:
      - echo 'ğŸ” Checking coverage thresholdsâ€¦'
      - "{{.GRADLEW}} checkCoverage --continue"
      - echo 'âœ… Coverage verification completed'

  # --- Pre-commit -------------------------------------------
  pre-commit:
    desc: Run checks before commit
    deps: [lint, format, "test:unit"]

  # --- Changelog / Docs / Release ---------------------------
  changelog:
    desc: Generate changelog from git commits
    cmds:
      - echo 'ğŸ“ Generating changelogâ€¦'
      - |
        PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo HEAD)
        {
          echo "## [{{.VERSION}}] - $(date +%F)"
          git log "$PREV_TAG"..HEAD --pretty=format:'* %s' --no-merges
          [ -f CHANGELOG.md ] && cat CHANGELOG.md
        } > CHANGELOG.md.tmp
      - mv CHANGELOG.md.tmp CHANGELOG.md
      - echo 'âœ… Changelog generated'

  "docs:generate":
    desc: Generate project documentation
    cmds:
      - echo 'ğŸ“š Generating documentationâ€¦'
      - "{{.GRADLEW}} dokkaHtml"
      - "echo 'âœ… Documentation: app/build/dokka/html/'"

  github-release:
    desc: Create GitHub release with artifacts
    deps: [validate-version, "build:fat-jar", changelog]
    cmds:
      - echo 'ğŸ” Checking GitHub CLI authenticationâ€¦'
      - gh auth status || (echo 'âŒ GitHub CLI not authenticated' && exit 1)
      - echo 'ğŸ” Verifying git repositoryâ€¦'
      - git rev-parse --is-inside-work-tree || (echo 'âŒ Not a git repository' && exit 1)
      - echo "ğŸ·ï¸  Creating git tag v{{.VERSION}}â€¦"
      - git tag -a "v{{.VERSION}}" -m "Release v{{.VERSION}}"
      - git push origin "v{{.VERSION}}"
      - echo 'ğŸ“¦ Creating GitHub releaseâ€¦'
      - gh release create "v{{.VERSION}}" --title "Release v{{.VERSION}}" ./app/build/libs/ssl-test-{{.VERSION}}*.jar
      - echo 'âœ… GitHub release created successfully'

  check:
    desc: Run all quality checks (lint, test, build)
    deps: [lint, test, build]

  "security:scan":
    desc: Run security vulnerability scan
    cmds:
      - echo 'ğŸ”’ Running security scanâ€¦'
      - "{{.GRADLEW}} dependencyCheckAnalyze || echo 'âš ï¸  dependency-check plugin not configured'"
      - echo 'âœ… Security scan completed'

  "dependencies:update":
    desc: Check for dependency updates
    cmds:
      - echo 'ğŸ“¦ Checking for dependency updatesâ€¦'
      - "{{.GRADLEW}} dependencyUpdates || echo 'âš ï¸  Versions-plugin not configured'"
      - echo 'âœ… Dependency check completed'

  "dependencies:report":
    desc: Generate dependency report
    cmds:
      - echo 'ğŸ“Š Generating dependency reportâ€¦'
      - "{{.GRADLEW}} dependencies --configuration runtimeClasspath"
      - echo 'âœ… Dependency report generated'

  dev:
    desc: Development workflow (clean, compile, test)
    deps: [clean, compile, test]

  ci:
    desc: Continuous integration workflow
    deps: [check, "test:coverage", "security:scan"]

  release:
    desc: Complete release workflow
    deps: [ci, "build:fat-jar", github-release]

  help:
    desc: Show help message
    cmds:
      - echo 'Run `task --list` to see all available tasks.'
      - echo 'See README.md for more details.'

  default:
    desc: Show help message (alias for help)
    deps: [help]
